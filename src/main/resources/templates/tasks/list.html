<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Tasks Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <!-- Flash Messages -->
  <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <h2>Tasks</h2>

  <!-- Add Task Form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Add New Task</h5>
      <form th:action="@{/tasks}" method="post">
        <div class="mb-3">
          <label for="title" class="form-label">Title</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label for="categoryId" class="form-label">Category</label>
          <select class="form-control" id="categoryId" name="categoryId">
            <option value="">Select Category</option>
            <option th:each="category : ${categories}"
                    th:value="${category.id}"
                    th:text="${category.name}">
            </option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Tags</label>
          <div th:each="tag : ${tags}" class="form-check">
            <input class="form-check-input" type="checkbox"
                   th:id="'tag' + ${tag.id}"
                   th:value="${tag.id}"
                   name="tagIds">
            <label class="form-check-label"
                   th:for="'tag' + ${tag.id}"
                   th:text="${tag.name}">
            </label>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Task</button>
      </form>
    </div>
  </div>

  <!-- Tasks List -->
  <div class="card">
    <div class="card-body">
      <table class="table">
        <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Category</th>
          <th>Tags</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="task : ${tasks}">
          <td th:text="${task.title}"></td>
          <td th:text="${task.description}"></td>
          <td th:text="${task.category != null ? task.category.name : ''}"></td>
          <td>
            <span th:each="tag, iterStat : ${task.tags}"
                  class="badge bg-secondary me-1"
                  th:text="${tag.name + (iterStat.last ? '' : ', ')}">
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-warning edit-task"
                    th:data-id="${task.id}"
                    th:data-title="${task.title}"
                    th:data-description="${task.description}"
                    th:data-category-id="${task.category != null ? task.category.id : ''}"
                    th:data-tag-ids="${task.tags}"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal">
              Edit
            </button>
            <form th:action="@{/tasks/{id}/delete(id=${task.id})}"
                  method="post" style="display: inline;">
              <button type="submit" class="btn btn-sm btn-danger"
                      onclick="return confirm('Are you sure?')">Delete</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editForm" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="editCategoryId" class="form-label">Category</label>
            <select class="form-control" id="editCategoryId" name="categoryId">
              <option value="">Select Category</option>
              <option th:each="category : ${categories}"
                      th:value="${category.id}"
                      th:text="${category.name}">
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Tags</label>
            <div th:each="tag : ${tags}" class="form-check">
              <input class="form-check-input edit-tag-checkbox"
                     type="checkbox"
                     th:id="'editTag' + ${tag.id}"
                     th:value="${tag.id}"
                     name="tagIds">
              <label class="form-check-label"
                     th:for="'editTag' + ${tag.id}"
                     th:text="${tag.name}">
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.querySelectorAll('.edit-task').forEach(button => {
    button.addEventListener('click', () => {
      const id = button.getAttribute('data-id');
      const title = button.getAttribute('data-title');
      const description = button.getAttribute('data-description');
      const categoryId = button.getAttribute('data-category-id');
      const tags = button.getAttribute('data-tag-ids');

      document.getElementById('editTitle').value = title;
      document.getElementById('editDescription').value = description;
      document.getElementById('editCategoryId').value = categoryId || '';

      document.querySelectorAll('.edit-tag-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });

      if (tags) {
        const tagElements = JSON.parse(tags);
        tagElements.forEach(tag => {
          const checkbox = document.getElementById('editTag' + tag.id);
          if (checkbox) {
            checkbox.checked = true;
          }
        });
      }

      document.getElementById('editForm').action = `/tasks/${id}`;
    });
  });

  // Auto-hide flash messages after 5 seconds
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
      setTimeout(function() {
        const closeButton = alert.querySelector('.btn-close');
        if (closeButton) {
          closeButton.click();
        }
      }, 5000);
    });
  });
</script>
</body>
</html>